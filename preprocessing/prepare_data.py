import argparse
import logging
from pathlib import Path

import pandas as pd

RAW_DATASETS_DIR = Path("data/raw")
PREPROCESSED_DATASETS_DIR = Path("data/preprocessed")
RAW_DATASETS_DIR.mkdir(exist_ok=True)
PREPROCESSED_DATASETS_DIR.mkdir(exist_ok=True)
DEFAULT_MIN_DATE = pd.Timestamp("1900-01-01")
DEFAULT_MAX_DATE = pd.Timestamp.today()

BASE_URL = "https://stooq.com/q/d/l/?s={ticker}"
TICKERS = {
    # stocks from WIG20 (30.04.2009) which are still available
    "WIG20": [
        "PKO",
        "PEO",
        "OPL",
        "PKN",
        "KGH",
        "PGN",
        "ACP",
        "GTC",
        "SPL",
        "PBG",
        "CEZ",
        "GTN",
        "PXM",
        "MBK",
        "CPS",
        "LTS",
        "AGO",
        "BIO",
    ],
    "WIG-BANKI": [
        "ALR",
        "BNP",
        "BOS",
        "GTN",
        "GNB",
        "BHW",
        "ING",
        "MBK",
        "MIL",
        "PEO",
        "PKO",
        "SPL",
        "SAN",
        "UCG",
    ],
    "mWIG40": [
        "11B",
        "ALR",
        "AMC",
        "ASB",
        "ASE",
        "ATT",
        "BDX",
        "BFT",
        "BHW",
        "BML",
        "CAR",
        "CIE",
        "CLN",
        "CMR",
        "DAT",
        "DOM",
        "DVL",
        "EAT",
        "ENA",
        "EUR",
        "FMF",
        "GPW",
        "HUGE",
        "ING",
        "KER",
        "KRU",
        "KTY",
        "LVC",
        "MAB",
        "MBK",
        "MIL",
        "NEU",
        "PCO",
        "PEP",
        "PKP",
        "PLW",
        "SLV",
        "TEN",
        "WPL",
        "XTB",
    ],
    "sWIG80": [
        "1AT",
        "ABE",
        "ABS",
        "ACG",
        "ACT",
        "AGO",
        "AMB",
        "AML",
        "APR",
        "APT",
        "ARH",
        "AST",
        "ATC",
        "BIO",
        "BMC",
        "BNP",
        "BOS",
        "BRS",
        "CIG",
        "CMP",
        "COG",
        "CRJ",
        "CRM",
        "CTX",
        "DBC",
        "DCR",
        "ECH",
        "ENT",
        "ERB",
        "FRO",
        "FTE",
        "GNB",
        "GRN",
        "GTC",
        "GTN",
        "IMC",
        "INK",
        "KGN",
        "LBW",
        "LWB",
        "MBR",
        "MCI",
        "MGT",
        "MLS",
        "MRB",
        "NWG",
        "OAT",
        "OND",
        "OPN",
        "PBX",
        "PCE",
        "PCF",
        "PCR",
        "PEN",
        "PHN",
        "PXM",
        "QRS",
        "R22",
        "RBW",
        "RFK",
        "RVU",
        "SEN",
        "SHO",
        "SKA",
        "SKH",
        "SNK",
        "SNT",
        "STP",
        "STX",
        "TIM",
        "TOA",
        "TOR",
        "TRK",
        "UNT",
        "VGO",
        "VOX",
        "VRG",
        "WLT",
        "WWL",
        "ZEP",
    ],
    # all available on https://stooq.pl/t/?i=513 (05.02.2022)
    "GPW": [
        "01C",
        "06N",
        "08N",
        "11B",
        "1AT",
        "2CP",
        "3RG",
        "4FM",
        "4MB",
        "4MS",
        "7FT",
        "7LV",
        "AAS",
        "AAT",
        "ABE",
        "ABK",
        "ABS",
        "ACA",
        "ACG",
        "ACP",
        "ACT",
        "ADV",
        "ADX",
        "AER",
        "AFC",
        "AFH",
        "AGL",
        "AGO",
        "AGP",
        "AGT",
        "AIN",
        "AIT",
        "ALD",
        "ALE",
        "ALG",
        "ALI",
        "ALL",
        "ALR",
        "ALU",
        "AMB",
        "AMC",
        "AML",
        "AMV",
        "ANR",
        "AOL",
        "APA",
        "APC",
        "APE",
        "APL",
        "APN",
        "APR",
        "APS",
        "APT",
        "AQA",
        "AQT",
        "AQU",
        "ARE",
        "ARG",
        "ARH",
        "ARI",
        "ARR",
        "ART",
        "ARX",
        "ASA",
        "ASB",
        "ASE",
        "ASM",
        "ASP",
        "ASR",
        "AST",
        "ATA",
        "ATC",
        "ATD",
        "ATG",
        "ATJ",
        "ATL",
        "ATO",
        "ATP",
        "ATR",
        "ATS",
        "ATT",
        "AUG",
        "AUX",
        "AVE",
        "AVT",
        "AWM",
        "AZC",
        "B24",
        "BAH",
        "BBA",
        "BBD",
        "BBT",
        "BCI",
        "BCM",
        "BCS",
        "BCSA",
        "BCX",
        "BDG",
        "BDX",
        "BDZ",
        "BEP",
        "BER",
        "BFC",
        "BFT",
        "BGD",
        "BHW",
        "BHX",
        "BIO",
        "BIP",
        "BIPA",
        "BKD",
        "BKM",
        "BLO",
        "BLR",
        "BLT",
        "BLU",
        "BMC",
        "BML",
        "BMX",
        "BNP",
        "BOS",
        "BOW",
        "BPC",
        "BPN",
        "BPX",
        "BRA",
        "BRG",
        "BRH",
        "BRO",
        "BRS",
        "BSA",
        "BST",
        "BTC",
        "BTG",
        "BTK",
        "BTX",
        "BVT",
        "CAI",
        "CAM",
        "CAR",
        "CAV",
        "CBD",
        "CCC",
        "CCE",
        "CCR",
        "CCS",
        "CDA",
        "CDL",
        "CDR",
        "CDT",
        "CEZ",
        "CFG",
        "CFI",
        "CFS",
        "CHP",
        "CIE",
        "CIG",
        "CLA",
        "CLC",
        "CLD",
        "CLE",
        "CLN",
        "CMC",
        "CMI",
        "CMP",
        "CMR",
        "CNT",
        "COG",
        "CPA",
        "CPD",
        "CPG",
        "CPL",
        "CPR",
        "CPS",
        "CRB",
        "CRC",
        "CRI",
        "CRJ",
        "CRM",
        "CRP",
        "CRS",
        "CSR",
        "CTE",
        "CTF",
        "CTS",
        "CTX",
        "CWP",
        "CZT",
        "DAD",
        "DAM",
        "DAT",
        "DBC",
        "DBE",
        "DCD",
        "DCR",
        "DDI",
        "DEG",
        "DEK",
        "DEL",
        "DEV",
        "DGA",
        "DGE",
        "DGN",
        "DKR",
        "DNP",
        "DNS",
        "DOK",
        "DOM",
        "DOW",
        "DPL",
        "DRE",
        "DRF",
        "DRG",
        "DTR",
        "DTX",
        "DUA",
        "DVL",
        "EAH",
        "EAT",
        "EBX",
        "ECC",
        "ECH",
        "ECK",
        "ECL",
        "ECO",
        "ECR",
        "ECT",
        "EDI",
        "EDN",
        "EEX",
        "EFE",
        "EFK",
        "EGH",
        "EHG",
        "EKP",
        "EKS",
        "ELM",
        "ELQ",
        "ELT",
        "ELZ",
        "EMA",
        "EMC",
        "EMM",
        "EMU",
        "ENA",
        "ENE",
        "ENG",
        "ENI",
        "ENP",
        "ENT",
        "EON",
        "EPR",
        "ERA",
        "ERB",
        "ERG",
        "ERH",
        "ESK",
        "EST",
        "ETL",
        "ETX",
        "EUC",
        "EUR",
        "EXA",
        "EXC",
        "EXM",
        "F51",
        "FEE",
        "FEM",
        "FER",
        "FFI",
        "FHD",
        "FIG",
        "FIV",
        "FKD",
        "FLG",
        "FMF",
        "FMG",
        "FON",
        "FOR",
        "FPO",
        "FRO",
        "FSG",
        "FTE",
        "FTH",
        "FTN",
        "FVE",
        "GAL",
        "GBK",
        "GCN",
        "GDC",
        "GEM",
        "GEN",
        "GIF",
        "GIG",
        "GKI",
        "GKS",
        "GLC",
        "GME",
        "GMT",
        "GMV",
        "GNB",
        "GNG",
        "GNR",
        "GOB",
        "GOL",
        "GOP",
        "GOV",
        "GPH",
        "GPP",
        "GPW",
        "GRC",
        "GRE",
        "GRM",
        "GRN",
        "GRX",
        "GTC",
        "GTCA",
        "GTF",
        "GTN",
        "GTP",
        "GTS",
        "GTY",
        "GX1",
        "HDR",
        "HEL",
        "HLD",
        "HMI",
        "HMP",
        "HOR",
        "HPS",
        "HRC",
        "HRL",
        "HRP",
        "HRS",
        "HRT",
        "HUB",
        "HUGE",
        "HYD",
        "I2D",
        "IBC",
        "IBS",
        "ICA",
        "ICD",
        "ICE",
        "IDG",
        "IDH",
        "IDM",
        "IFA",
        "IFC",
        "IFI",
        "IFR",
        "IGN",
        "IGS",
        "IGT",
        "IIA",
        "IMC",
        "IMG",
        "IMP",
        "IMR",
        "IMS",
        "INC",
        "INF",
        "ING",
        "INK",
        "INL",
        "INM",
        "INP",
        "INS",
        "INT",
        "INV",
        "IPE",
        "IPF",
        "IPO",
        "IPW",
        "IRL",
        "ISG",
        "IST",
        "ITB",
        "ITL",
        "ITM",
        "IUS",
        "IVE",
        "IVO",
        "IWS",
        "IZB",
        "IZO",
        "IZS",
        "JJB",
        "JRH",
        "JSW",
        "JWA",
        "JWW",
        "K2H",
        "K2P",
        "KBD",
        "KBJ",
        "KBT",
        "KCH",
        "KCI",
        "KDM",
        "KER",
        "KGH",
        "KGL",
        "KGN",
        "KIN",
        "KLN",
        "KME",
        "KMP",
        "KOM",
        "KOR",
        "KPC",
        "KPD",
        "KPI",
        "KPL",
        "KRC",
        "KRI",
        "KRK",
        "KRU",
        "KSG",
        "KTY",
        "KVT",
        "LAB",
        "LBD",
        "LBT",
        "LBW",
        "LCN",
        "LEG",
        "LEN",
        "LET",
        "LGT",
        "LKD",
        "LKS",
        "LMG",
        "LPP",
        "LPS",
        "LRK",
        "LRQ",
        "LSH",
        "LSI",
        "LTS",
        "LTX",
        "LUG",
        "LUK",
        "LVC",
        "LWB",
        "M4B",
        "MAB",
        "MAD",
        "MAK",
        "MAN",
        "MAX",
        "MBF",
        "MBK",
        "MBR",
        "MBW",
        "MCE",
        "MCI",
        "MCP",
        "MCR",
        "MDA",
        "MDB",
        "MDG",
        "MDI",
        "MDN",
        "MDP",
        "MEG",
        "MEI",
        "MER",
        "MEX",
        "MFD",
        "MFO",
        "MGT",
        "MIL",
        "MIR",
        "MLB",
        "MLG",
        "MLK",
        "MLP",
        "MLS",
        "MLT",
        "MMA",
        "MMC",
        "MMD",
        "MMS",
        "MNC",
        "MND",
        "MNS",
        "MOJ",
        "MOL",
        "MON",
        "MOV",
        "MPH",
        "MPS",
        "MPY",
        "MRB",
        "MRC",
        "MRD",
        "MRG",
        "MRH",
        "MRK",
        "MSM",
        "MSP",
        "MSW",
        "MSZ",
        "MTE",
        "MTN",
        "MTR",
        "MTS",
        "MVP",
        "MVR",
        "MWT",
        "MXC",
        "MXP",
        "MZA",
        "NEU",
        "NFP",
        "NGG",
        "NNG",
        "NOB",
        "NOV",
        "NRS",
        "NST",
        "NTS",
        "NTT",
        "NTU",
        "NTV",
        "NTW",
        "NVA",
        "NVG",
        "NVT",
        "NWA",
        "NWG",
        "NXB",
        "NXG",
        "OAT",
        "OBL",
        "ODL",
        "OEX",
        "OML",
        "ONC",
        "OND",
        "ONE",
        "OPF",
        "OPG",
        "OPI",
        "OPL",
        "OPM",
        "OPN",
        "OPT",
        "ORG",
        "ORL",
        "OTM",
        "OTS",
        "OUT",
        "OVI",
        "OVO",
        "OXY",
        "OZE",
        "P24",
        "P2B",
        "P2C",
        "PAS",
        "PAT",
        "PBB",
        "PBF",
        "PBG",
        "PBT",
        "PBX",
        "PCE",
        "PCF",
        "PCG",
        "PCO",
        "PCR",
        "PCX",
        "PDG",
        "PEN",
        "PEO",
        "PEP",
        "PFG",
        "PFM",
        "PGE",
        "PGM",
        "PGN",
        "PGV",
        "PHN",
        "PHR",
        "PIG",
        "PIT",
        "PIX",
        "PJP",
        "PKN",
        "PKO",
        "PKP",
        "PLE",
        "PLG",
        "PLI",
        "PLM",
        "PLW",
        "PLX",
        "PLZ",
        "PMA",
        "PMP",
        "PNT",
        "PNW",
        "PPG",
        "PPS",
        "PRD",
        "PRI",
        "PRM",
        "PRN",
        "PRO",
        "PRS",
        "PRT",
        "PSH",
        "PSM",
        "PSW",
        "PTE",
        "PTG",
        "PTH",
        "PTN",
        "PTW",
        "PUE",
        "PUN",
        "PUR",
        "PWX",
        "PXM",
        "PYL",
        "PZU",
        "QNT",
        "QON",
        "QRS",
        "QRT",
        "QUB",
        "R22",
        "RAF",
        "RBS",
        "RBW",
        "RCA",
        "RCW",
        "RDG",
        "RDL",
        "RDN",
        "RDS",
        "REG",
        "REM",
        "RES",
        "RFK",
        "RHD",
        "RLP",
        "RMK",
        "RNC",
        "RND",
        "RNK",
        "RON",
        "ROV",
        "RPC",
        "RSP",
        "RST",
        "RVU",
        "RWL",
        "S4E",
        "SAN",
        "SBE",
        "SCP",
        "SCS",
        "SDG",
        "SED",
        "SEK",
        "SEL",
        "SEN",
        "SES",
        "SEV",
        "SFD",
        "SFG",
        "SFK",
        "SFN",
        "SFS",
        "SGN",
        "SGR",
        "SHD",
        "SHG",
        "SHO",
        "SIM",
        "SIN",
        "SKA",
        "SKH",
        "SKL",
        "SKN",
        "SKT",
        "SLV",
        "SLZ",
        "SME",
        "SMT",
        "SNG",
        "SNK",
        "SNT",
        "SNW",
        "SNX",
        "SOK",
        "SOL",
        "SON",
        "SPH",
        "SPK",
        "SPL",
        "SPR",
        "STA",
        "STD",
        "STF",
        "STH",
        "STI",
        "STP",
        "STS",
        "STX",
        "SUL",
        "SUN",
        "SUW",
        "SVRS",
        "SWD",
        "SWG",
        "SWK",
        "SWT",
        "SYG",
        "SYM",
        "SZR",
        "T2P",
        "TAR",
        "TBL",
        "TEN",
        "TGG",
        "TGS",
        "THD",
        "THG",
        "TIM",
        "TLG",
        "TLO",
        "TLS",
        "TLT",
        "TLV",
        "TLX",
        "TME",
        "TMP",
        "TMR",
        "TOA",
        "TOR",
        "TOS",
        "TOW",
        "TPE",
        "TRI",
        "TRK",
        "TRN",
        "TRR",
        "TSG",
        "TXF",
        "TXM",
        "TXN",
        "U2K",
        "UCG",
        "UFC",
        "ULG",
        "ULM",
        "UNI",
        "UNL",
        "UNT",
        "URS",
        "URT",
        "VAB",
        "VAR",
        "VDS",
        "VEE",
        "VER",
        "VGO",
        "VIA",
        "VIN",
        "VIV",
        "VKT",
        "VLT",
        "VOT",
        "VOX",
        "VRB",
        "VRC",
        "VRF",
        "VRG",
        "VTI",
        "VTL",
        "VVD",
        "WAS",
        "WAT",
        "WHH",
        "WIK",
        "WIS",
        "WLT",
        "WOD",
        "WOJ",
        "WPL",
        "WPR",
        "WRE",
        "WRL",
        "WTN",
        "WWL",
        "WXF",
        "XBS",
        "XPL",
        "XTB",
        "XTP",
        "YAN",
        "YOL",
        "YOS",
        "ZAP",
        "ZEN",
        "ZEP",
        "ZMT",
        "ZRE",
        "ZRX",
        "ZUE",
        "ZUK",
        "ZWC",
    ],
}


def download(ticker: str) -> pd.DataFrame:
    data_url = BASE_URL.format(ticker=ticker)
    return pd.read_csv(data_url)


def is_downloaded(ticker: str) -> bool:
    return (RAW_DATASETS_DIR / f"{ticker}.csv").is_file()


def preprocess(df: pd.DataFrame) -> pd.DataFrame:
    df["Date"] = pd.to_datetime(df["Date"])
    df["Change"] = df["Close"].pct_change()
    df = df[["Date", "Change"]].set_index("Date")
    return df


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("-t", "--ticker", action="append", default=[])
    parser.add_argument("-i", "--index", action="append", default=[])
    parser.add_argument("-n", "--name", default="dataset")
    parser.add_argument("-f", "--force", action="store_true")
    parser.add_argument("-v", "--verbose", action="store_true")

    args = parser.parse_args()
    # Configure logging
    if args.verbose:
        logging.basicConfig(level=logging.INFO)

    # Prepare list of all considered tickers
    tickers = set(args.ticker)
    for index in args.index:
        if index in TICKERS:
            tickers.update(TICKERS[index])
        else:
            logging.warn(f"Index {index} not known.")

    # Download stock data for all tickers if not available
    for ticker in tickers:
        if not is_downloaded(ticker) or args.force:
            logging.info(f"{ticker} not found. Downloading...")
            df = download(ticker)
            df.to_csv(RAW_DATASETS_DIR / f"{ticker}.csv")
        else:
            logging.info(f"{ticker} found. Skip.")

    dfs = {}
    min_date = DEFAULT_MIN_DATE
    max_date = DEFAULT_MAX_DATE
    for ticker in tickers:
        df = pd.read_csv(RAW_DATASETS_DIR / f"{ticker}.csv")
        try:
            df = preprocess(df)
        except Exception as err:
            logging.error(f"Failed to preprocess {ticker}: {err}")
            raise err
        dfs[ticker] = df

        # Find minimum and maximum date across the data
        min_date = max(min_date, df.index.min())
        max_date = min(max_date, df.index.max())
    min_date += pd.Timedelta(days=1)

    # Limit dates
    for ticker in dfs:
        dfs[ticker] = dfs[ticker][str(min_date) : str(max_date)]

    # Create single final table
    final_df = pd.DataFrame()

    for ticker, df in dfs.items():
        final_df[ticker] = df["Change"]

    # Drop all nans
    final_df = final_df.dropna()
    final_df.to_csv(Path("data") / f"{args.name}.csv")
